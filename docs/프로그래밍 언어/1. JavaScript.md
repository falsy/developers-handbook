# JavaScript

자바스크립트는 다양한 자바스크립트 엔진(V8, SpiderMonkey, Chakra 등..) 위에서 또 다양한 환경(Node.js, 웹 브라우저 등..)에서 동작합니다. 간단한 이해의 범주에서는 그 내용이 크게 다르지 않을 수 있지만 그래도 이 문서에서 따로 설명이 되어있지 않는 경우, 많이 사용되고 가장 정보가 많은 `V8`과 `웹 브라우저` 환경을 기준으로 작성하였습니다.

## 1. 자바스크립트 엔진

크게 언어는 인터프리터 언어와 정적 컴파일 언어로 나눌 수 있는데요, 인터프리터 방식은 코드를 실행 시점에서 라인 단위로 해석하여 기계어 코드로 실행하는 방식으로 대부분 스크립트 언어로 JavaScript, Python, Ruby, PHP 등..이 있습니다. 그리고 정적 컴파일 방식은 코드 실행 전에 전체를 컴파일하여 기계어로 변환된 실행 파일을 기반으로 동작하는 방식으로 C, Go, Swift, Rust 등..이 있습니다.

하지만 현대 프로그래밍 언어 대부분은 인터프리터 방식과 컴파일 방식을 함께 사용하는 혼합형 실행 모델을 사용합니다. 그리고 자바스크립트 역시 인터프리터 언어로 출발하였지만, 현대 자바스크립트 엔진(V8, SpiderMonkey, JavaScriptCore 등..)은 JIT 컴파일러와 프로파일링 최적화 기술을 사용합니다.

#### JIT(Just-In-Time)

> JIT는 소스코드를 실행 직전 또는 실행 도중에 기계어로 컴파일하는 기술을 이야기합니다. 그리고 자바스크립트의 JIT는 여러가지의 최적화 기법을 활용하는데, 예를 들어 인라인 캐싱을 통해 동일한 키의 객체 프로퍼티를 자주 읽는 경우 이를 캐싱하여 프로퍼티의 접근 속도를 높이거나 타입 추론을 통해서 변수의 타입을 추론하여 정적 타입 언어처럼 최적화된 기계어를 생성하는 등..이 있습니다.

자바스크립트 엔진이 코드를 해석할 때, 우선 자바스크립트 코드를 `추상 구문 트리(AST: Abstract Syntax Tree)`로 파싱합니다.

#### AST(Abstract Syntax Tree)

> AST는 프로그래밍 언어의 소스 코드 구조를 트리 형태로 표현한 데이터 구조로, 프로그래밍 언어의 문법을 계층적으로 나타냅니다. 이 정보를 가지고 컴파일러나 인터프리터가 코드를 이해하고 처리합니다.

자바스크립트는 자바스크립트 코드를 `렉싱(Lexing)`이라는 단계를 통해 소스를 읽어 키워드, 식별자, 연산자, 리터널 등..을 토큰으로 분해합니다. 그리고 토큰을 바탕으로 AST 트리를 생성합니다.

이제 생성된 AST 트리를 바탕으로 인터프리터 또는 컴파일러가 AST 트리를 `중간 표현(IR: Intermediate Representation)`으로 변환한 후 이를 기반으로 바이트코드를 생성합니다. 여기서 인터프리터는 바로 코드를 해석하고 실행하기에 빠르지만 반복적인 수행에 대해서 효율이 나쁘다는 문제가 있고 JIT 컴파일은 여러가지 최적화와 캐싱으로 반복 수행에 대해 빠르게 동작하지만 런타임 환경에서 수행되기 때문에 오버 헤드를 피할 수 없습니다. 또한 자바스크립트는 변수의 타입이 변할 수 있는 동적 언어이기 때문에 이는 정적 언어와 같은 최적화에는 한계가 있습니다.

그래서 최근의 자바스크립트 엔진들은 `적응형 JIT 컴파일(Adaptive JIT Compilation)`방식을 사용합니다. Adaptive JIT는 초기에 `Baseline JIT`가 간단화 최적화만을 수행하며 빠르게 바이트 코드로 변환하여 실행 가능한 초기 형태를 만듭니다. 그리고 실행 중에 코드를 분석하고 프로파일링하여 어떤 함수가 자주 호출되고 또 변수의 데이터 타입이나 반복문에서 사용되는 데이터 패턴 정보를 수집하여 자주 실행되는 코드를 중요도가 높은 `핫스팟`으로 설정하고 핫스팟으로 식별된 코드는 `Optimizing JIT`가 인라인 캐싱, 함수 인라이닝, 타입 추론 등의 최적화 기법을 사용하여 기계어로 변환합니다. 만약 Optimizing JIT를 통한 최적화 과정 중 문제가 생기면 최적화 전의 상태(Baseline JIT에서 생성된 바이트코드)로 되돌립니다.(`Deoptimization`)

마지막으로 간단하게 정리하자면, 자바스크립트 엔진은 자바스크립트 코드를 파싱하여 `AST`를 만들고 AST를 가지고 `Adaptive JIT Compilation`방식을 사용하여 초기에 `Baseline JIT`가 바이트코드를 생성합니다. 그리고 런타임 중에 코드의 실행 빈도나 데이터 패턴들을 프로파일링하고 `Optimizing JIT`가 핫스팟으로 식별된 코드를 최적화하여 기계어로 변환합니다. 그리고 최종적으로 Baseline JIT에서 만들어진 바이트코드와 Optimizing JIT를 통해 만들어진 기계어를 통해 브라우저에서 실행됩니다.
